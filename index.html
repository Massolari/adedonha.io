<html>

<head>
	<title>Adedonha</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
	<script src="/socket.io/socket.io.js"></script>
	<script type="text/javascript" src="/vue/dist/vue.js"></script>
	<script type="text/javascript" src="/jquery/dist/jquery.min.js"></script>
	<link rel="stylesheet" href="/bootstrap/dist/css/bootstrap.min.css">
	<script type="text/javascript" src="/bootstrap/dist/js/bootstrap.js"></script>
	<style type="text/css">
		/* Note: Try to remove the following lines to see the effect of CSS positioning */
		.affixIn {
			background: #B8C1C8;
			border-bottom: 1px solid #989EA4;
			border-top: 1px solid #717D85;
			color: #FFF;
			margin: 0;
			padding: 2px 0 0 12px;
			position: -webkit-sticky;
			position: sticky;
			top: -1px;
		}
			
		.affixOut {
			font: bold 20px/45px Helvetica, Arial, sans-serif;
			margin: 0;
			padding: 0 0 0 12px;
			white-space: nowrap;
		}
	</style>
</head>

<body>
	<script>const socket = io()</script>
	<!--nav class="navbar navbar-inverse" data-spy="affix" data-offset-top="197">
	<p class="nav navbar-nav">Nav test</p>
	</nav-->
	<div id="app" class="container-fluid">
	
		<div class="row">
		    <div class="col-sm-6"><h2>Adedonha</h2>

		<div v-if="!logado">
			<form @submit.prevent="logar">
				<div class="input-group">
					<div class="input-group-prepend">
						<span class="input-group-text">Nome</span>
					</div>
					<input type="text" class="form-control" v-model="nome">
					<button :disabled="alguemCriando" class="btn btn-primary">{{ botaoEntrar }}</button>
				</div>
			</form>
		</div>
		<div v-if="logado && !jogoCriado">
			<form @submit.prevent="criar">
				<div class="input-group" v-for="a in assuntos" :key="a.id">
					<div class="input-group-prepend">
						<span class="input-group-text">Nome</span>
					</div>
					<input type="text" class="form-control" v-model="a.nome" required>
					<button :disabled="assuntos.length === 1" @click="removerAssunto(a.id)" type="button" class="btn btn-danger">Remover</button>
				</div>
				<button @click="adicionarAssunto" type="button" class="btn btn-primary">Adicionar</button>
				<div class="input-group">
					<div class="input-group-prepend">
						<span class="input-group-text">Tempo</span>
					</div>
					<input type="text" class="form-control" v-model="tempoCriacao" required>
				</div>
				<button class="btn btn-primary">Criar</button>
			</form>
		</div>
		<div v-if="logado && jogoCriado">
			<hr />
			<h3>{{ this.nome }} - Pontos: {{ pontos }}</h3>
			<p>{{ (jogadores.length === 1) ? "Aguardando mais jogadores para começar a partida" : `Jogadores: ${jogadores.length}` }}</p>
			<h2>Letra: {{ letra }}</h2><span>Rodada: {{ rodadas }}</span>
			<!--nav class="navbar navbar-inverse" data-spy="affix" data-offset-top="0"-->	
				<div class="progress affixOut">
					<div class="progress-bar progress-bar-striped progress-bar-animated affixIn" :class="{ 'bg-warning': barraTempo > 25 && barraTempo <= 50, 'bg-danger': barraTempo <= 25 }" role="progressbar" :style="{ width: `${barraTempo}%` }" aria-valuenow="100"  aria-valuemin="0" aria-valuemax="100">Tempo</div>
				</div>
			
			<div class="input-group" v-for="a in assuntos" :key="a.id">
				<div class="input-group-prepend">
					<span class="input-group-text">{{ a.nome }}</span>
				</div>
				<input type="text" class="form-control" :disabled="fimPartida || terminei" v-model="a.resposta">
				<div v-show="fimPartida" class="input-group-prepend">
					<span class="input-group-text">Pontos</span>
				</div>
				<select v-show="fimPartida" :disabled="pontosConfirmados || a.resposta.trim().length === 0" class="form-control" v-model="a.pontos">
					<option value="0">0</option>
					<option value="5">5</option>
					<option value="10">10</option>
				</select>
				<!-- input type="text" v-show="fimPartida" :disabled="pontosConfirmados || a.resposta.trim().length === 0" class="form-control" v-model="a.pontos" -->
			</div>
			<button @click="confirmarPontos" :disabled="pontosConfirmados" class="btn btn-success" v-show="fimPartida">Confirmar pontos</button>
			<button class="btn btn-success" v-show="!fimPartida && jogadores.length > 1 && !iniciando" :disabled="terminei" @click="terminar">{{ terminei ? "Aguardando os outros jogadores..." : "Terminei" }}</button>
			<hr />
			<h4>Ranking</h4>
			<ol>
				<li v-for="j in jogadoresOrdenados">{{ `${j.nome}  - Pontos: ${j.pontos} ${(j.terminou) ? "Terminou!" : ""}${(j.confirmou) ? "Confirmou!" : ""}` }}</li>
			</ol>
		</div>
		    </div></div></div>
	<script>
		socket.on("criando", v => {
		    app.alguemCriando = v
		})
		socket.on("jogo", jogo => {
		    app.jogoCriado = jogo.criado
		    app.alguemCriando = jogo.criando
		})
		socket.on("atualizarJogadores", jogadores => {
		    app.jogadores = jogadores
		})
		socket.on("tempo", tempo => {
		    app.barraTempo = tempo
		})
		socket.on("iniciando", contagem => {
			app.iniciando = true
			app.letra = `${contagem}...`
		})
		socket.on("novaRodada", dados => {
			app.iniciando = false
			if (dados.jogadores.length === 1) {
				app.pontos = 0
			}
		    app.barraTempo = 100
		    app.fimPartida = false
			app.letra = dados.letra
			app.rodadas = dados.rodadas
		    app.assuntos = dados.assuntos.map(a => ({
		        id: a.id,
				nome: a.nome,
				pontos: 0,
				resposta: ""
		    }))
		    app.jogadores = dados.jogadores
		})
		socket.on("fim", v => {
		    app.terminei = false
		    app.fimPartida = v
		    app.pontosConfirmados = false
		})
		const app = new Vue({
		    el: "#app",
		    data: {
				logado: false,
				nome: "",
				jogoCriado: false,
				alguemCriando: false,
				assuntos: [{ id: 1, nome: "", resposta: "" }],
				tempoCriacao: 0,
				pontos: 0,
				fimPartida: false,
				jogadores: [],
				letra: "Aguardando...",
				pontosConfirmados: false,
				barraTempo: 100,
				rodadas: 0,
			    terminei: false,
			    iniciando: false
		    },
		    methods: {
		        logar() {
					this.logado = true
					if (this.jogoCriado) {
						socket.emit("entrar", this.nome)
						return
					}
					socket.emit("criando")
				},
				adicionarAssunto() {
					let max = 0
					this.assuntos.forEach(a => {
						if (a.id > max) {
							max = a.id
						}
					})
					this.assuntos.push({ id: max + 1, nome: "" })
				},
				removerAssunto(id) {
					this.assuntos = this.assuntos.filter(a => a.id !== id)
				},
				criar() {
					socket.emit("criar", {
						assuntos: this.assuntos,
						nome: this.nome,
						tempo: this.tempoCriacao
					})
					this.assuntos = []
					this.jogoCriado = true
				},
				confirmarPontos() {
					if (confirm("Deseja confirmar seus pontos?")) {
						this.pontosConfirmados = true
						this.pontos += this.assuntos.reduce((acc, ass) => acc + Number(ass.pontos), 0)
						socket.emit("confirmados", this.pontos)
					}
				},
			        terminar() {
				    if (confirm("Terminou de preencher as palavras?")) {
					this.terminei = true
					socket.emit("terminei")
				    }
				}
		    },
		    computed: {
				botaoEntrar() {
					if (this.alguemCriando) {
					return "Alguém está criando o jogo..."
					}
					return (this.jogoCriado) ? "Entrar" : "Criar"
				},
				jogadoresOrdenados() {
					return this.jogadores.sort((a, b) => - (a.pontos - b.pontos))
				}
		    }
		})
	</script>
</body>

</html>